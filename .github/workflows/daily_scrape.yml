name: Gunluk Trend Takipcisi

on:
  schedule:
    # UTC saatiyle 06:00 (TR 09:00) ve 18:00 (TR 21:00)
    - cron: '0 6,18 * * *'
  workflow_dispatch: # Manuel tetikleme butonu

jobs:
  scrape-and-process:
    runs-on: ubuntu-latest
    # İşlem bir yerde takılırsa 45 dakika sonra zorla durdur (Kredi koruması)
    timeout-minutes: 45

    steps:
      - name: Depoyu Çek (Checkout)
        uses: actions/checkout@v4

      - name: Python Kurulumu (3.11)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Pip paketlerini önbelleğe alarak sonraki çalışmayı hızlandırır

      # Chrome için gerekli modern kütüphaneler
      - name: Gerekli Sistem Paketlerini Yükle (Xvfb ve Libs)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libnss3 libfontconfig1 libx11-xcb1 libgbm1 libasound2

      - name: Kütüphaneleri Yükle
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt

      - name: Ustabaşı Scriptini Çalıştır (Main)
        env:
          # Secret'lar burada ortam değişkenine dönüşür
          OPENROUTER_KEY: ${{ secrets.OPENROUTER_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          # Python'un çıktıyı tamponlamasını engeller (Logları anlık görmek için)
          PYTHONUNBUFFERED: "1"
        run: |
          # Ekran varmış gibi davranarak main.py'yi çalıştır
          # Çıktı klasörü oluştur (Script oluşturmuyorsa garanti olsun)
          mkdir -p output
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" python scraper/main.py

      # --- EKLENEN KISIM BAŞLANGICI ---
      - name: Sonuçları Kaydet (Upload Artifact)
        uses: actions/upload-artifact@v4
        if: always() # Script hata verip çökse bile çalışır (Hata ayıklama için kritik)
        with:
          name: trend-sonuclari # İndirilecek zip dosyasının adı
          # DİKKAT: Python kodunun dosyaları kaydettiği klasör burası olmalı.
          # Eğer scriptin 'downloads' klasörüne kaydediyorsa burayı değiştir.
          path: output/ 
          retention-days: 5 # Dosyalar GitHub'da 5 gün saklansın
      # --- EKLENEN KISIM BİTİŞİ ---