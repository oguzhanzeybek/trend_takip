name: Gunluk Trend Takipcisi

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

permissions:
  contents: write # DosyayÄ± repoya kaydetmek iÃ§in gerekli izin

jobs:
  scrape-and-process:
    runs-on: ubuntu-latest
    # DÃœZELTME BURADA: 15 dakika yetmediÄŸi iÃ§in 60 dakikaya Ã§Ä±karÄ±ldÄ±.

    steps:
      - name: Depoyu Ã‡ek (Checkout)
        uses: actions/checkout@v3

      - name: Python Kurulumu (3.11)
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Chrome ve Chromedriver Kurulumu
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      - name: KÃ¼tÃ¼phaneleri YÃ¼kle
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt

      - name: UstabaÅŸÄ± Scriptini Ã‡alÄ±ÅŸtÄ±r
        env:
          PYTHONUNBUFFERED: "1" # LoglarÄ± anlÄ±k gÃ¶sterir
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENROUTER_KEY: ${{ secrets.OPENROUTER_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_KEY }}
        run: |
          # Hata durumunda (read timeout) scriptin tamamen durmamasÄ± iÃ§in continue mekanizmasÄ± python iÃ§inde olmalÄ±
          # Ancak burada sÃ¼reyi uzattÄ±ÄŸÄ±mÄ±z iÃ§in scriptin iÅŸini bitirmesi muhtemeldir.
          python scraper/main.py

      # --- KAYIT BÃ–LÃœMÃœ ---
      - name: CSV'yi Repoya Kaydet (Commit & Push)
        # Script hata alsa bile (yarÄ±da kalsa bile) eldeki veriyi kaydetmesi iÃ§in:
        if: always()
        run: |
          git config --global user.name 'Trend Botu'
          git config --global user.email 'bot@github.com'

          # SÄ°GORTA ADIMI:
          # EÄŸer Python hala eski ismi (n11_sonuc) Ã¼retiyorsa, ismini trend_takip yapalÄ±m:
          if [ -f scraper/n11_sonuc.csv ]; then
            mv scraper/n11_sonuc.csv scraper/trend_takip.csv
            echo "Dosya ismi n11_sonuc -> trend_takip olarak deÄŸiÅŸtirildi."
          fi

          # DosyayÄ± ekle (Dosya yoksa hata verme, loga yaz)
          git add scraper/trend_takip.csv || echo "âš ï¸ Kaydedilecek dosya bulunamadÄ±!"

          # DeÄŸiÅŸiklik varsa commit at ve gÃ¶nder
          git commit -m "ğŸ“ˆ Trend Takip Verisi: $(date +'%Y-%m-%d %H:%M')" || echo "DeÄŸiÅŸiklik yok."
          git push
